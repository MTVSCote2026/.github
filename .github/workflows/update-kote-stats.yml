name: Update KOTE stats

on:
  schedule:
    - cron: "0 0 * * *"   # 매일 00:00 UTC (= 한국 09:00)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout .github repo
        uses: actions/checkout@v4

      - name: Clone public repos (skip if missing, never fail)
        shell: bash
        run: |
          set +e
          ORG="${{ github.repository_owner }}"
          mkdir -p repos

          clone_if_exists () {
            local repo="$1"
            local url="https://github.com/${ORG}/${repo}.git"
            local tmp="repos/${repo}.tmp"
            local dst="repos/${repo}"

            # 레포가 없어도/네트워크 이슈여도 실패하지 않게 처리
            git ls-remote --exit-code "$url" >/dev/null 2>&1
            if [ $? -ne 0 ]; then
              echo "Skipping (not found): ${repo}"
              return 0
            fi

            rm -rf "$tmp" "$dst"
            echo "Cloning: ${repo}"

            git clone --depth 200 "$url" "$tmp" >/dev/null 2>&1
            if [ $? -eq 0 ] && [ -d "$tmp/.git" ]; then
              mv "$tmp" "$dst"
            else
              rm -rf "$tmp"
              echo "Clone failed but continuing: ${repo}"
            fi
            return 0
          }

          # 확정 레포
          clone_if_exists "carttman"
          clone_if_exists "flatroad"

          # 나중에 정해지면 여기만 바꾸거나 추가하세요.
          clone_if_exists "repo3"
          clone_if_exists "repo4"

          exit 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update README (never fail)
        run: |
          python .github/scripts/update_kote_stats.py || true

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add profile/README.md || true
          git diff --cached --quiet || git commit -m "chore: update KOTE stats"
          git push
